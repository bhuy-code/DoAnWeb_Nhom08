<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Chi tiết sản phẩm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    /* CSS riêng cho trang chi tiết */
    .detail-container { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px; }
    .detail-img { width: 100%; border-radius: 12px; object-fit: cover; }
    .detail-info h1 { font-size: 28px; margin-bottom: 10px; }
    .detail-price { font-size: 24px; color: #d32f2f; font-weight: bold; margin-bottom: 20px; }
    .detail-desc { color: #555; line-height: 1.6; margin-bottom: 30px; }
    
    /* CSS cho các nút size trong Modal */
    .size-options { display: flex; gap: 10px; margin: 15px 0; }
    .size-option {
      padding: 8px 15px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;
      transition: 0.2s;
    }
    .size-option:hover { background: #f0f0f0; }
    .size-option.active { background: #007bff; color: white; border-color: #007bff; }

    @media(max-width:768px){ .detail-container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<header class="header">
  <div class="container">
    <nav class="nav" aria-label="Primary">
      <a href="index.html" class="brand">
        <span class="logo" aria-hidden="true"></span>
        <span>Clothify</span>
      </a>
      <div>
        <a href="index.html">Trang chủ</a>
        <a href="products.html">Sản phẩm</a>
        <a href="cart.html" style="position: relative;">
          Giỏ hàng
          <span id="cart-counter" class="cart-badge"></span>
        </a>
        <a href="about.html">Giới thiệu</a>
        <a href="contact.html">Liên hệ</a>
      </div>
      <div class="cta">
        <a class="btn ghost" href="login.html" aria-label="Đăng nhập">Đăng nhập</a>
        <a class="btn primary" href="products.html" aria-label="Mua ngay">Mua ngay</a>
      </div>
    </nav>
  </div>
  <!-- Thanh tìm kiếm -->
  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Tìm kiếm sản phẩm..." />
    <button id="search-btn">Tìm</button>
  </div>
</header>

<main class="container">
  <div id="product-detail" class="detail-container">
    </div>
</main>

<div id="size-modal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" id="modal-close-btn">&times;</button>

    <div class="modal-product-info">
      <img src="" alt="Sản phẩm" id="modal-product-image">
      <div>
        <h3 id="modal-product-name">Tên sản phẩm</h3>
        <span id="modal-product-price">Giá</span>
      </div>
    </div>

    <div class="modal-options">
      <h4>Chọn size:</h4>
      <div id="modal-size-options" class="size-options"></div>
    </div>
    <div class="modal-options" style="margin-top: 15px;">
      <h4>Số lượng:</h4>
      <div style="display: flex; align-items: center; gap: 10px;">
        <button id="modal-quantity-decrease" class="btn" style="width: 40px; height: 40px; padding: 0; font-size: 20px;">-</button>
        <input type="number" id="modal-quantity-input" value="1" min="1" max="10" style="width: 80px; text-align: center; padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
        <button id="modal-quantity-increase" class="btn" style="width: 40px; height: 40px; padding: 0; font-size: 20px;">+</button>
      </div>
    </div>

    <button class="modal-confirm-btn" id="modal-confirm-add-btn">Xác nhận thêm</button>
  </div>
</div>
<script src="assets/js/script.js"></script>
<script src="assets/js/products.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Lấy ID từ thanh địa chỉ
    const params = new URLSearchParams(window.location.search);
    const productId = params.get("id");

    // Lấy sản phẩm từ localStorage
    const catalog = JSON.parse(localStorage.getItem('productCatalog')) || [];
    let product = catalog.find(p => p.id === productId);

    const container = document.getElementById("product-detail");

    if (product) {
      // Nếu tìm thấy -> Hiển thị
      const sizes = product.availableSizes || ['S', 'M', 'L', 'XL'];
      container.innerHTML = `
        <div>
          <img src="${product.image || ''}" alt="${product.name}" class="detail-img">
        </div>
        <div class="detail-info">
          <h1>${product.name}</h1>
          <div class="detail-price">${(product.price || 0).toLocaleString('vi-VN')}₫</div>
          <p class="detail-desc">${product.description || "Chưa có mô tả"}</p>
          
          <button class="btn primary" 
                  id="open-size-modal-btn"
                  data-product-id="${product.id}"
                  data-available-sizes="${sizes.join(',')}">
            Thêm vào giỏ
          </button>
          <a href="products.html" class="btn ghost">Quay lại</a>
        </div>
      `;

      // Gán sự kiện cho nút thêm vào giỏ
      const openBtn = document.getElementById("open-size-modal-btn");
      if (openBtn) {
        openBtn.addEventListener("click", (e) => {
          e.preventDefault();
          
          // Kiểm tra đăng nhập
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser) {
            alert("⚠️ Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng!");
            window.location.href = "login.html";
            return;
          }
          
          // Mở modal
          const modal = document.getElementById("size-modal");
          const modalImg = document.getElementById("modal-product-image");
          const modalName = document.getElementById("modal-product-name");
          const modalPrice = document.getElementById("modal-product-price");
          const sizeContainer = document.getElementById("modal-size-options");
          const modalConfirmBtn = document.getElementById("modal-confirm-add-btn");
          
          if (modal && modalImg && modalName && modalPrice && sizeContainer) {
            modalImg.src = product.image || '';
            modalName.innerText = product.name;
            modalPrice.innerText = (product.price || 0).toLocaleString('vi-VN') + '₫';
            
            // Tạo nút size
            sizeContainer.innerHTML = "";
            let selectedSize = null;
            sizes.forEach(size => {
              const sizeBtn = document.createElement("button");
              sizeBtn.classList.add("size-option");
              sizeBtn.innerText = size.trim();
              sizeBtn.setAttribute("data-size", size.trim());
              sizeBtn.addEventListener("click", () => {
                sizeContainer.querySelectorAll(".size-option").forEach(btn => btn.classList.remove("active"));
                sizeBtn.classList.add("active");
                selectedSize = size.trim();
                if (modalConfirmBtn) modalConfirmBtn.disabled = false;
              });
              sizeContainer.appendChild(sizeBtn);
            });
            
            if (modalConfirmBtn) {
              modalConfirmBtn.disabled = true;
              // Xóa event listener cũ
              const newBtn = modalConfirmBtn.cloneNode(true);
              modalConfirmBtn.parentNode.replaceChild(newBtn, modalConfirmBtn);
              
              newBtn.addEventListener("click", () => {
                if (!selectedSize) {
                  alert("Vui lòng chọn size!");
                  return;
                }
                
                const quantityInput = document.getElementById("modal-quantity-input");
                const quantity = parseInt(quantityInput?.value) || 1;
                
                // Thêm vào giỏ
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                const existingIndex = cart.findIndex(item => item.id === product.id && item.size === selectedSize);
                
                if (existingIndex > -1) {
                  cart[existingIndex].quantity += quantity;
                } else {
                  cart.push({
                    id: product.id,
                    name: product.name,
                    size: selectedSize,
                    price: product.price,
                    image: product.image,
                    quantity: quantity
                  });
                }
                
                localStorage.setItem('cart', JSON.stringify(cart));
                if (typeof updateCartCounter === 'function') updateCartCounter();
                
                alert('✓ Đã thêm sản phẩm vào giỏ hàng thành công!');
                modal.classList.remove("active");
              });
            }
            
            modal.classList.add("active");
          }
        });
      }

    } else {
      container.innerHTML = `
        <div style="text-align:center; padding:40px;">
          <h2>Không tìm thấy sản phẩm!</h2>
          <p>Có thể mã sản phẩm <b>${productId}</b> không tồn tại trong dữ liệu.</p>
          <a href="products.html" class="btn">Xem tất cả sản phẩm</a>
        </div>`;
    }
  });
</script>

<script src="assets/js/products.js"></script>
</body>
</html>